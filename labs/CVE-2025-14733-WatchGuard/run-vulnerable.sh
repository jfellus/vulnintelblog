#!/bin/bash

# Fireware refuses to serve the WebUI and management interface over an emulated user-mode networking.
# so we create TAP interfaces with a host-side IP address for both LAN and WAN sides.

# Clean up old interfaces if they exist
sudo ip link del tap0 2>/dev/null
sudo ip link del tap1 2>/dev/null
sudo ip link del br100 2>/dev/null

# TRUSTED management interface
sudo ip tuntap add dev tap0 mode tap user $USER
sudo ip addr add 10.0.1.2/24 dev tap0
sudo ip link set tap0 up

# WAN interface
sudo ip tuntap add dev tap1 mode tap user $USER
sudo ip link set tap1 up

# Bridge WAN
sudo ip link add name br100 type bridge
sudo ip link set br100 up
sudo ip link set tap1 master br100
sudo ip link set tap1 up
sudo ip addr add 10.0.10.2/24 dev br100
sudo ip link set br100 up

# Disable reverse path filtering on the interfaces and set promisc mode
sudo sysctl -w net.ipv4.conf.all.rp_filter=0
sudo sysctl -w net.ipv4.conf.default.rp_filter=0
sudo sysctl -w net.ipv4.conf.br100.rp_filter=0
sudo sysctl -w net.ipv4.conf.tap1.rp_filter=0
sudo ip link set br100 promisc on
sudo ip link set tap1 promisc on



# iptables allow syslog to host
sudo iptables -I INPUT -i tap0 -p udp --dport 514 -j ACCEPT
sudo iptables -I OUTPUT -o tap0 -p udp --dport 514 -j ACCEPT
# iptables allow IKEv2 VPN from host
sudo iptables -I INPUT -p udp --dport 500 -j ACCEPT
sudo iptables -I INPUT -p udp --dport 4500 -j ACCEPT

sudo qemu-system-x86_64 \
  -drive file=vulnerable/FireboxV_12_10_1.qcow2,format=qcow2 \
  -m 2G \
  -smp 2 \
  -enable-kvm \
  -netdev tap,id=wan,ifname=tap1,script=no,downscript=no \
  -device virtio-net-pci,netdev=wan \
  -netdev tap,id=lan,ifname=tap0,script=no,downscript=no \
  -device virtio-net-pci,netdev=lan
